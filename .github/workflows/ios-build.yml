name: Build iOS App

on:
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_IOS_API_KEY: ${{ secrets.VITE_IOS_API_KEY }}
          VITE_FIREBASE_VAPID_KEY: ${{ secrets.VITE_FIREBASE_VAPID_KEY }}
        run: npm run build

      - name: Install Apple Certificate and Provisioning Profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          PP_PLIST=$RUNNER_TEMP/profile.plist
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate and provisioning profile from secrets
          # BYPASSING SECRET: Read from repo file
          cat cert_FINAL_v5_base64_PURE.txt > cert_secret_b64.txt
          echo "MD5 of Repo File Text:"
          md5 cert_secret_b64.txt
          
          # Decode using file input (robust against whitespace/newlines)
          tr -d '\r\n ' < cert_secret_b64.txt | base64 -D -o $CERTIFICATE_PATH
          
          # BYPASSING SECRET: Read Profile from repo file (strip Windows BOM and line endings)
          sed $'1s/^\xEF\xBB\xBF//' profile_V2_base64.txt | tr -d '\r\n\t ' | base64 -D -o $PP_PATH
          
          # Debugging: Check file size and hash
          ls -l $CERTIFICATE_PATH
          md5 $CERTIFICATE_PATH
          ls -l $PP_PATH
          PP_SIZE=$(stat -f%z "$PP_PATH" 2>/dev/null || stat -c%s "$PP_PATH" 2>/dev/null || echo 0)
          if [ "$PP_SIZE" -lt 500 ]; then
            echo "::error::profile_V2_base64.txt decode produced too small a file ($PP_SIZE bytes). Re-create base64 on Windows with UTF-8 no BOM - see IOS_BUILD_KONTROL_LISTESI.md"
            exit 1
          fi

          # Decode provisioning profile to plist (required for reliable UUID extraction)
          if ! security cms -D -i "$PP_PATH" -o "$PP_PLIST" 2>/tmp/cms_err.txt; then
            echo "::error::Provisioning profile decode failed (security cms). profile_V2_base64.txt may be corrupted or not a valid .mobileprovision. On Windows re-create with UTF-8 no BOM - see IOS_BUILD_KONTROL_LISTESI.md"
            cat /tmp/cms_err.txt || true
            exit 1
          fi
          if [ ! -f "$PP_PLIST" ] || [ ! -s "$PP_PLIST" ]; then
            echo "::error::Provisioning profile plist missing or empty after decode. Check profile_V2_base64.txt is the base64 of the downloaded SmartMarket App Store .mobileprovision file."
            exit 1
          fi
          UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" "$PP_PLIST" 2>/dev/null || true)
          NAME=$(/usr/libexec/PlistBuddy -c "Print Name" "$PP_PLIST" 2>/dev/null || true)
          if [ -z "$UUID" ]; then
            echo "::error::Provisioning profile is missing UUID. Ensure the profile is an App Store distribution profile downloaded from Apple Developer, and that it includes 'Sign in with Apple' capability (App ID must have Sign in with Apple enabled, then regenerate the profile)."
            exit 1
          fi
          echo "PROVISIONING_PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "PROVISIONING_PROFILE_NAME=$NAME" >> $GITHUB_ENV
          echo "Using profile: $NAME ($UUID)"

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # apply provisioning profile (must be in standard location with correct name for Xcode)
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        run: |
          cd ios/App
          pod install

      - name: Build iOS App (Archive)
        env:
          scheme: "App"
        run: |
          # Inject provisioning profile into Release config only (do not touch Debug/Automatic)
          echo "Injecting Profile UUID: $PROVISIONING_PROFILE_UUID"
          sed -i '' "s/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Manual; PROVISIONING_PROFILE = \"$PROVISIONING_PROFILE_UUID\"; CODE_SIGN_IDENTITY = \"iPhone Distribution\";/" ios/App/App.xcodeproj/project.pbxproj

          cd ios
          xcodebuild -workspace App/App.xcworkspace \
            -scheme "App" \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -sdk iphoneos \
            -configuration Release \
            -destination generic/platform=iOS \
            archive > $RUNNER_TEMP/xcodebuild.log 2>&1
          BUILD_STATUS=$?
          echo "=== Son 300 satir (hata genelde burada) ==="
          tail -300 $RUNNER_TEMP/xcodebuild.log
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "::error::=== Build failed. Error satirlari ==="
            grep "error:" $RUNNER_TEMP/xcodebuild.log | head -30 || true
            exit $BUILD_STATUS
          fi

      - name: Export IPA
        env:
          EXPORT_OPTIONS_PLIST: App/App/ExportOptions.plist
        run: |
          cd ios
          
          # Update ExportOptions.plist with correct method and provisioning profile
          /usr/libexec/PlistBuddy -c "Set :method app-store-connect" $EXPORT_OPTIONS_PLIST
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" $EXPORT_OPTIONS_PLIST
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:com.lionx.smartmarket string $PROVISIONING_PROFILE_NAME" $EXPORT_OPTIONS_PLIST

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -exportOptionsPlist $EXPORT_OPTIONS_PLIST \
            -exportPath $RUNNER_TEMP/build \
            -allowProvisioningUpdates

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ${{ runner.temp }}/build/App.ipa

      - name: Upload to App Store Connect
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Create private keys directory
          mkdir -p ~/.appstoreconnect/private_keys
          
          # Decode API Key to the expected location and filename
          echo -n "$API_KEY_BASE64" | base64 --decode -o ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
          
          # Upload using altool
          xcrun altool --upload-app --type ios \
            --file "${{ runner.temp }}/build/App.ipa" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID"
